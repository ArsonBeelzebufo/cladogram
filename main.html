<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Cladogram</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            *{
                margin:0;
            }
            html,body{
                height:100%;
            }
            .header{
                height:10%;
                background-color:#333333;
            }
            .cladogram{
                position:relative;
                width:80%;
                height:60%;
                background-color:#555555;
            }
            .assembler{
                position:absolute;
                bottom:0;
                left:0;
                width:80%;
                height:30%;
                background-color:#333333;
            }
            .shiftstick{
                position:absolute;
                width:20%;
                height:90%;
                bottom:0%;
                right:0%;
                background-color:#444444;
                overflow-y:scroll;
            }
            .shiftbutton{
                margin-top:5%;
                margin-left:5%;
                width:90%;
                height:10%;
                background-color:#555555;
                font-family:"courier new";
                font-size:5vh;
                color:#FFFFFF;
                display:flex;
                justify-content:center;
                align-items:center;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            .form{
                position:absolute;
                background-color:#666666;
                font-family:"courier new";
                font-size:2vh;
                color:#FFFFFF;
                display:flex;
                justify-content:center;
                align-items:center;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        </style>
    </head>
    <body>
        <canvas id="canvas" style="display:block;height:0;"></canvas>
        <div class="header">
            <img src="cobweb.png" style="   position:absolute;
                                            height:8vh;
                                            width:8vh;
                                            top:1vh;
                                            right:1vh;"
                onclick="webmode()"></div>
        <div class="assembler" id="machine">
            <div id="paradigm" style="  position:absolute;
                                        left:50%;
                                        top:50%;
                                        transform:translate(-50%,-200%);
                                        font-family:courier new;
                                        font-size:3vh;
                                        color:#FFFFFF;
                                        -webkit-touch-callout: none;
                                        -webkit-user-select: none;
                                        -khtml-user-select: none;
                                        -moz-user-select: none;
                                        -ms-user-select: none;
                                        user-select: none;"></div>
            <div id="arrow" style=" position:absolute;
                                    left:50%;
                                    top:50%;
                                    transform:translate(-50%,-50%);
                                    font-family:courier new;
                                    font-size:10vh;
                                    color:#FFFFFF;
                                    -webkit-touch-callout: none;
                                    -webkit-user-select: none;
                                    -khtml-user-select: none;
                                    -moz-user-select: none;
                                    -ms-user-select: none;
                                    user-select: none;"></div>
            <div id="roots" style=" width:28vw;
                                    height:30vh;
                                    overflow-y:scroll;
                                    position:absolute;
                                    border-right:0px"></div>
            <div id="branch" style="position:absolute;
                                    left:50%;
                                    top:50%;
                                    width:6vw;
                                    height:7vh;
                                    background-color:#444444;
                                    transform:translate(200%,-50%);
                                    visibility:hidden;
                                    font-family:courier new;
                                    font-size:4vh;
                                    color:#FFFFFF;
                                    display:flex;
                                    justify-content:center;
                                    align-items:center;
                                    -webkit-touch-callout: none;
                                    -webkit-user-select: none;
                                    -khtml-user-select: none;
                                    -moz-user-select: none;
                                    -ms-user-select: none;
                                    user-select: none;"
                onclick="change(this)"></div></div>
        <div class="shiftstick" id="stick"></div>
        <div class="cladogram" id="field"></div>
    </body>
    <script>
        var button=0;
        var nForms,nShifters;
        function shift(element){
            if(button!=0){document.getElementById("button"+button.toString()).style.backgroundColor="#555555";}
            if(button!=element.id[6]){
                button=parseInt(element.id[6]);
                element.style.backgroundColor="#333333";
                document.getElementById("paradigm").innerHTML=element.innerHTML;
                document.getElementById("arrow").innerHTML="-----&gt;";
                resetBranch();
                document.getElementById("branch").style.visibility="visible";
                document.getElementById("roots").style.borderRight="2px solid #666666";
                destroyExForms();
            }else{  
                button=0;
                element.style.backgroundColor="#555555";
                document.getElementById("paradigm").innerHTML="";
                document.getElementById("arrow").innerHTML="";
                resetBranch();
                document.getElementById("roots").style.borderRight="0px";
                destroyExForms();
            }
        }
        function createForm(text,top,left,width,height){
            var form=document.createElement("div");
            form.innerHTML=text;
            form.setAttribute("class","form");
            form.setAttribute("id","form"+nForms.toString());
            form.setAttribute("onmousedown","dragForm(this,event)");
            form.setAttribute("ondblclick","duplicate(this)");
            form.setAttribute("oncontextmenu","destroy(this,event)");
            form.setAttribute("onclick","setBranch(this)");
            document.getElementById("field").appendChild(form);
            form.style.top=top.toString()+"%";
            form.style.left=left.toString()+"%";
            form.style.width=width.toString()+"%";
            form.style.height=height.toString()+"%";
            nForms++;
        }
        function createExForm(text,top){
            var form=document.createElement("div");
            form.innerHTML=text;
            form.setAttribute("class","form");
            form.setAttribute("ondblclick","duplicateEx(this)");
            document.getElementById("roots").appendChild(form);
            form.style.top=(2*top+1)*3.6+"vh";
            form.style.right="10%";
            form.style.width="3.2vw";
            form.style.height="3.6vh";
        }
        function destroyExForms(){
            roots=document.getElementById("roots").children;
            var len=roots.length
            for(let i=0;i<len;i++){roots[0].remove();}
        }
        function duplicateEx(element){
            createForm(element.innerHTML,0,0,4,6);
        }
        function dragForm(element,event){
            mouseDown(event);
            var x,y,newx,newy;
            function mouseDown(e){
                e=e||window.event;
                e.preventDefault();
                x=e.clientX;
                y=e.clientY;
                document.onmousemove=mouseMove;
                document.onmouseup=mouseUp;
            }
            function mouseMove(e){
                e=e||window.event;
                e.preventDefault();
                newy=(element.offsetTop+e.clientY-y)/element.parentElement.offsetHeight*100;
                newx=(element.offsetLeft+e.clientX-x)/element.parentElement.offsetWidth*100;
                x=e.clientX;
                y=e.clientY;
                if((0<=newx&&newx<=100-parseFloat(element.style.width)&&0<=newy&&newy<=100-parseFloat(element.style.height))||(parseFloat(element.style.left)<0||parseFloat(element.style.left)+parseFloat(element.style.width)>100||parseFloat(element.style.top)<0||parseFloat(element.style.top)+parseFloat(element.style.height)>100)){
                    element.style.top=newy.toString()+"%";
                    element.style.left=newx.toString()+"%";
                }else{
                    document.onmousemove=null;
                    document.onmouseup=null;
                }
            }
            function mouseUp(){
                document.onmousemove=null;
                document.onmouseup=null;
            }
        }
        function createShifter(id,initial,final){
            var shifter=document.createElement("div");
            shifter.innerHTML=initial+" -> "+final;
            shifter.setAttribute("class","shiftbutton");
            shifter.setAttribute("onclick","shift(this)");
            shifter.setAttribute("id","button"+id.toString());
            document.getElementById("stick").appendChild(shifter);
        }
        function duplicate(element){
            createForm( element.innerHTML,
                        parseFloat(element.style.top)-5,
                        parseFloat(element.style.left)-5,
                        parseFloat(element.style.width),
                        parseFloat(element.style.height));
        }
        function destroy(element,e){
            e=e||window.event;
            e.preventDefault();
            var troubleID=parseInt(element.id.slice(4));
            field=document.getElementById("field").children;
            for(var i=0;i<field.length;i++){
                var child=field[i];
                if(child.id.slice(0,4)=="form"){
                    var oID=parseInt(child.id.slice(4));
                    if(oID>troubleID){
                        child.setAttribute("id","form"+(oID-1).toString());
                    }
                }
            }
            nForms--;
            element.remove();
        }
        function change(element){
            if(element.style.backgroundColor=="rgb(68, 68, 68)"){
                element.style.backgroundColor="#222222";
            }else{
                element.style.backgroundColor="#444444";
            }
        }
        function setBranch(element){
            var branch=document.getElementById("branch");
            var go=(branch.style.backgroundColor=="rgb(34, 34, 34)");
            if(go){
                destroyExForms();
                branch.innerHTML=element.innerHTML;
                change(branch);
                roots=findRoots(branch.innerHTML,document.getElementById("paradigm").innerHTML);
                for(let i=0;i<roots.length;i++){
                    createExForm(roots[i],i);
                }
            }
        }
        function resetBranch(){
            var branch=document.getElementById("branch");
            branch.style.visibility="hidden";
            branch.style.backgroundColor="#444444";
            branch.innerHTML="";
        }
        function findRoots(branch,paradigmHTML){
            var paradigm=paradigmHTML.split(" -&gt; ");
            var ans=[""];
            for(var char of branch){
                if(char==paradigm[1]){
                    halfLength=ans.length;
                    ans=[...ans,...ans];
                    for(let i=0;i<halfLength;i++){
                        ans[i]+=char;
                        ans[i+halfLength]+=paradigm[0];
                    }
                }else{
                    for(let i=0;i<ans.length;i++){
                        ans[i]+=char;
                    }
                }
            }
            return ans.slice(1);
        }
        var webbing=false;
        var first=true;
        var firstID,secondID;
        function web(element){
            if(first){
                firstID=element.id;
            }else{
                secondID=element.id;
            }first=!first;
            if(first&firstID!=secondID){
                var x1=parseInt(document.getElementById(firstID).style.left)+.5*parseInt(document.getElementById(firstID).style.width);
                var y1=parseInt(document.getElementById(firstID).style.top)+.5*parseInt(document.getElementById(firstID).style.height);
                var x2=parseInt(document.getElementById(secondID).style.left)+.5*parseInt(document.getElementById(secondID).style.width);
                var y2=parseInt(document.getElementById(secondID).style.top)+.5*parseInt(document.getElementById(secondID).style.height);
                var width=document.getElementById("field").offsetWidth;
                var height=document.getElementById("field").offsetHeight;
                var dims=getWebDims(x1,y1,x2,y2,width,height);
                arrow=document.createElement("div");
                arrow.style=`   font-family:courier new;
                                font-size:2vh;
                                color:#FFFFFF;
                                display:flex;
                                justify-content:center;
                                align-items:center;
                                -webkit-touch-callout:none; 
                                -webkit-user-select:none;
                                -khtml-user-select:none;
                                -moz-user-select:none;
                                -ms-user-select:none;
                                user-select:none;
                                position:absolute;
                                height:${dims[1]}%;
                                left:${dims[2]}%;
                                top:${dims[3]}%;
                                transform:rotate(${dims[4]}rad);
                                overflow:visible;`;
                var canvas=document.getElementById("canvas");
                var context=canvas.getContext("2d");
                context.font="2vh courier new";
                arrow.innerHTML=`${'-'.repeat(Math.floor(dims[0]*width/100/context.measureText('-').width-1))}&gt;`;
                document.getElementById("field").prepend(arrow);
            }
        }
        function diagonal(angleIn,width,height){
            var limit=Math.atan(height/width);
            var angle=Math.abs(angleIn);
            if(angle<limit){
                return width/Math.cos(angle);
            }else{
                return height/Math.sin(angle);
            }
        }
        function getWebDims(x1,y1,x2,y2,xPx,yPx){
            var dx=xPx*(x2-x1);
            var dy=yPx*(y2-y1);
            var angle=Math.atan(dy/dx);
            var width=Math.sqrt(dx**2+dy**2)-100*diagonal(angle,.04*xPx,.06*yPx);
            var height=6*yPx;
            var left=.5*((x1+x2)*xPx-width);
            var top=.5*((y1+y2)*yPx-height);
            return [width/xPx,height/yPx,left/xPx,top/yPx,angle];
        }
        function webmode(){
            webbing=!webbing;
            if(webbing){
                resetBranch();
                var forms=document.getElementById("field").children;
                var shifts=document.getElementById("stick").children;
                for(let i=0;i<shifts.length;i++){
                    first=true;
                    if(shifts[i].id.slice(0,6)=="button"){
                        shifts[i].setAttribute("onclick","");
                    }
                }
                for(let i=0;i<forms.length;i++){
                    if(forms[i].id.slice(0,4)=="form"){
                        forms[i].setAttribute("onclick","web(this)");
                        forms[i].setAttribute("onmousedown","");
                        forms[i].setAttribute("ondblclick","");
                        forms[i].setAttribute("oncontextmenu","");
                    }
                }
            }else{
                var forms=document.getElementById("field").children;
                var shifts=document.getElementById("stick").children;
                for(let i=0;i<shifts.length;i++){
                    if(shifts[i].id.slice(0,6)=="button"){
                        shifts[i].setAttribute("onclick","shift(this)");
                    }
                }
                for(let i=0;i<forms.length;i++){
                    if(forms[i].id.slice(0,4)=="form"){
                        forms[i].setAttribute("onclick","setBranch(this)");
                        forms[i].setAttribute("onmousedown","dragForm(this,event)");
                        forms[i].setAttribute("ondblclick","duplicate(this)");
                        forms[i].setAttribute("oncontextmenu","destroy(this,event)");
                    }
                }
            }
        }
        function init(){
            var forms=["abce","ahce","fbce","agci","jgcd"];
            nForms=0;
            forms.forEach(function(form,index,array){
                createForm(form,41+12*(array.length/2-index),60,4,6);
            });
            var shifters=[["d","e"],["a","f"],["b","g"],["b","h"],["d","i"],["a","j"]];
            nShifters=shifters.length;
            shifters.forEach(function(shifter,index){
                createShifter(index+1,shifter[0],shifter[1]);
            });
        }init();
    </script>
</html>